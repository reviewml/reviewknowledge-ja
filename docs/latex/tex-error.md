2019/8/22 by @kmuto

# TeX 実行時のエラーを読み解く

Re:VIEW から TeX 経由の PDF 生成の途中でエラーが発生したときの、原因の調べ方を説明します。

----

## TeX 実行の流れ

最初に、Re:VIEW から TeX 経由で PDF を生成するときに、どういうプロセスになっているのかを理解しておく必要があります。デフォルトでは以下のような流れです。

1. 作業用一時フォルダが生成される。これはシステムのテンポラリフォルダにランダムな名前で作成されて途中でエラーがあっても必ず最後に消されてしまうが、 config.yml で `debug: true` にしていた場合はプロジェクトフォルダ内に `<booknameの名前>-pdf` という名前で作られ、消されない。
2. re ファイルが逐次 .tex 拡張子の LaTeX ファイルに変換され、一時フォルダ内に置かれる。
3. 各 .tex ファイルをとりまとめる `__REVIEW_BOOK__.tex` が置かれ、さらにプロジェクトフォルダの sty サブフォルダの中身、および images フォルダの図版ファイル群が一時フォルダ内にコピーされる。
4. images フォルダの図版ファイル群に対して `extractbb` コマンド (見つからなければ `ebb` コマンド) が実行され、ファイルの縦横サイズが .xbb ファイルに記録される。
5. `__REVIEW_BOOK__.tex` ファイルに対して config.yml の `texcommand` と `texoptions` を合体させたコマンドが実行される。つまり、`uplatex -interaction=nonstopmode -file-line-error __REVIEW_BOOK__.tex` が実行される。これで、`__REVIEW_BOOK__.dvi` というファイルができる。
6. 相互参照や目次などの解決のため、5.は3回繰り返し実行される。
7. `__REVIEW_BOOK__.dvi` ファイルに対して `dvicommand` と `dvioptions` を合体させたコマンドが実行される。つまり、`dvipdfmx -d 5 -z 9 __REVIEW_BOOK__.dvi` が実行される。これで、`__REVIEW_BOOK__.pdf` というファイルができる。
8. 一時フォルダ内の `__REVIEW_BOOK__.pdf` ファイルを、プロジェクトフォルダに `<booknameの名前>.pdf` という名前でコピーする。
9. `debug: true` でない場合は一時フォルダを消去する。

.re→.tex 変換 (ステップ2.) は Re:VIEW の管轄なので、ここで文法エラーであったり図版ファイルが不足していたりなどの明確な問題を発見したときには Re:VIEW のレベルでエラーが発生し、re ファイルの行番号も添えられるので簡単に解決できるはずです。

これに対し、4.〜67 の時点でエラーが発生したときには、すでに Re:VIEW の手を離れています。

- マクロの解釈およびページ組み立ては uplatex の段階です。
- フォントの実際の埋め込みは、dvipdfmx の段階です。
- 図版ファイルの変換 (eps→PDF など) および実際の埋め込みは、dvipdfmx の段階です。


## 

## 文字が落ちる

エラーは出ないものの、PDF を作ってみると特定の文字が消失している、という現象があるかもしれません。たいていの場合、それは絵文字でしょう。
★
エラーではないものの、dvipdfmx の実行で「Tried to set a nonexistent character in a virtual font」のようなメッセージが出ることがあります。

デフォルトで使用している upLaTeX は Unicode 範囲の文字を扱えるようになっていますが、Unicode のすべての文字を受け入れて出力できるというわけではありません。

絵文字

- [upTeXでUnicodeできない話](https://zrbabbler.hatenablog.com/entry/20150803/1438617651])
